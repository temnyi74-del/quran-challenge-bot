# quran_bot.py
import asyncio
import logging
import os
from datetime import datetime, timedelta, time

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message

# â”€â”€ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logging.basicConfig(level=logging.INFO)

# â”€â”€ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BOT_TOKEN = os.getenv("BOT_TOKEN")                 # Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
GROUP_ID  = int(os.getenv("GROUP_ID", "0"))        # id Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (ÑĞ¾ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼ -100...)
TIMEZONE_OFFSET = int(os.getenv("TZ_OFFSET", "5")) # ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ UTC, Ğ½Ğ°Ğ¿Ñ€. Ğ§ĞµĞ»ÑĞ±Ğ¸Ğ½ÑĞº = +5

if not BOT_TOKEN or GROUP_ID == 0:
    raise RuntimeError("ĞÑƒĞ¶Ğ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‚ÑŒ BOT_TOKEN Ğ¸ GROUP_ID Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ.")

bot = Bot(token=BOT_TOKEN)
dp  = Dispatcher()

# â”€â”€ Ğ ĞµĞ°ĞºÑ†Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ñ„Ğ¾Ñ‚Ğ¾ Ğ² Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ â”€â”€â”€â”€â”€
@dp.message(F.chat.id == GROUP_ID, F.photo)
async def handle_photo(message: Message):
    # Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ğ¾, ĞºĞ°Ğº Ğ¿Ñ€Ğ¾ÑĞ¸Ğ»
    await message.answer("Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ")
    await message.answer("ĞŸÑƒÑÑ‚ÑŒ ĞĞ»Ğ»Ğ°h Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ‚,")
    await message.answer("Ø¢Ù…ÙŠÙ† ğŸ¤²")

# â”€â”€ 30 Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°ÑˆĞµĞº (Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº, Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ² Ğ´ĞµĞ½ÑŒ) â”€â”€
MOTIVATIONS = [
    "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½Ğµ Ğ²ÑĞµ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¸Ğ»Ğ¸ÑÑŒ. Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ±ÑƒĞ´ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½ĞµĞµ, Ğ¸Ğ½ ÑˆĞ° ĞĞ»Ğ»Ğ°Ñ…!",
    "ĞĞµ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ ĞšĞ¾Ñ€Ğ°Ğ½Ğ° â€” ÑÑ‚Ğ¾ ÑĞ²ĞµÑ‚ Ğ² ÑĞµÑ€Ğ´Ñ†Ğµ.",
    "ĞĞ»Ğ»Ğ°Ñ… Ğ»ÑĞ±Ğ¸Ñ‚ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°ĞµÑ‚ÑÑ Ñ€Ğ°Ğ´Ğ¸ ĞĞµĞ³Ğ¾.",
    "ĞšÑ‚Ğ¾ Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ÑÑ Ğ·Ğ° ĞšĞ¾Ñ€Ğ°Ğ½ â€” Ñ‚Ğ¾Ñ‚ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ·Ğ°Ğ±Ğ»ÑƒĞ´Ğ¸Ñ‚ÑÑ.",
    "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ñ ĞšĞ¾Ñ€Ğ°Ğ½Ğ¾Ğ¼ â€” Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğº Ğ Ğ°Ñ.",
    "ĞŸÑƒÑÑ‚ÑŒ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ±Ğ°Ñ€Ñ€Ğ°ĞºÑÑ‚Ğ° Ğ² Ğ½Ğ°ÑˆĞ¸Ñ… ÑÑ‚Ğ°Ñ€Ğ°Ğ½Ğ¸ÑÑ….",
    "Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ²Ğ¼ĞµÑÑ‚Ğµ ÑƒĞºÑ€ĞµĞ¿Ğ¸Ğ¼ Ğ½Ğ°ÑˆÑƒ ÑĞ²ÑĞ·ÑŒ Ñ ĞšĞ½Ğ¸Ğ³Ğ¾Ğ¹ ĞĞ»Ğ»Ğ°Ñ…Ğ°.",
    "Â«Ğ’Ğ¾Ğ¸ÑÑ‚Ğ¸Ğ½Ñƒ, ÑÑ‚Ğ¸Ğ¼ ĞšĞ¾Ñ€Ğ°Ğ½Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞĞ½, ĞºĞ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°ĞµÑ‚Â» (39:23).",
    "Ğ¡ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ Ğ°ÑÑ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ¶Ğ°ĞµĞ¼ÑÑ Ğº Ğ´Ğ¾Ğ²Ğ¾Ğ»ÑŒÑÑ‚Ğ²Ñƒ ĞĞ»Ğ»Ğ°Ñ…Ğ°.",
    "Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° â€” ĞµÑ‰Ñ‘ Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ğ½Ñ Ğ¿Ñ€Ğ¾ÑĞ²Ğ¸Ñ‚ÑŒ ÑƒÑĞµÑ€Ğ´Ğ¸Ğµ.",
    "ĞšĞ¾Ñ€Ğ°Ğ½ â€” Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´Ñ€ÑƒĞ³ Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ¼Ğ¸Ñ€Ğµ Ğ¸ Ğ² ĞÑ…Ğ¸Ñ€Ğ°.",
    "ĞšÑ‚Ğ¾ Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ ĞšĞ¾Ñ€Ğ°Ğ½ â€” Ğ½Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ÑĞµÑ€Ğ´Ñ†Ğµ ÑĞ²ĞµÑ‚Ğ¾Ğ¼.",
    "ĞĞ»Ğ»Ğ°Ñ… Ğ²Ğ¾Ğ·Ğ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ»ÑĞ´ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· ĞšĞ¾Ñ€Ğ°Ğ½.",
    "Ğ£ÑĞµÑ€Ğ´Ğ¸Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ â€” Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ğ° Ğ² Ğ¡ÑƒĞ´Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.",
    "Ğ¡Ğ»Ğ¾Ğ²Ğ¾ ĞĞ»Ğ»Ğ°Ñ…Ğ° â€” Ğ»ĞµĞºĞ°Ñ€ÑÑ‚Ğ²Ğ¾ Ğ´Ğ»Ñ Ğ´ÑƒÑˆ Ğ¸ ÑĞµÑ€Ğ´ĞµÑ†.",
    "ĞĞµ ÑƒĞ¿ÑƒÑĞºĞ°Ğ¹ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ·Ğ¸Ñ‚ÑŒÑÑ Ğº ĞĞ»Ğ»Ğ°Ñ…Ñƒ Ñ‡ĞµÑ€ĞµĞ· Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ.",
    "ĞšĞ¾Ñ€Ğ°Ğ½ Ğ²ĞµĞ´Ñ‘Ñ‚ Ğº ÑÑ‡Ğ°ÑÑ‚ÑŒÑ Ğ¸ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ¸Ñ.",
    "ĞŸÑƒÑÑ‚ÑŒ Ğ½Ğ°ÑˆĞ¸ ÑĞµÑ€Ğ´Ñ†Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¼ÑĞ³ĞºĞ¸Ğ¼Ğ¸ Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ñ ĞšĞ¾Ñ€Ğ°Ğ½Ñƒ.",
    "ĞĞ»Ğ»Ğ°Ñ… Ğ¾Ğ±Ğ»ĞµĞ³Ñ‡Ğ¸Ñ‚ Ğ¿ÑƒÑ‚ÑŒ Ğ² Ğ Ğ°Ğ¹ Ñ‚ĞµĞ¼, ĞºÑ‚Ğ¾ ÑƒÑ‡Ğ¸Ñ‚ ĞšĞ¾Ñ€Ğ°Ğ½.",
    "ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ â€” ÑÑ‚Ğ¾ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ğ°.",
    "ĞŸÑƒÑÑ‚ÑŒ ĞšĞ¾Ñ€Ğ°Ğ½ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½Ğ°ÑˆĞ¸Ğ¼ Ğ·Ğ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸ĞºĞ¾Ğ¼ Ğ² Ğ¡ÑƒĞ´Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.",
    "ĞĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ»Ğ¾ÑÑ‚Ğ¸, ĞºĞ¾Ğ³Ğ´Ğ° Ñ€ÑĞ´Ğ¾Ğ¼ ĞšĞ¾Ñ€Ğ°Ğ½.",
    "ĞĞ»Ğ»Ğ°Ñ… Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿ÑƒÑ‚Ğ¸ Ñ‚ĞµĞ¼, ĞºÑ‚Ğ¾ Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ÑÑ Ğ·Ğ° Ğ•Ğ³Ğ¾ ĞšĞ½Ğ¸Ğ³Ñƒ.",
    "Ğ¡Ğ»Ğ¾Ğ²Ğ° ĞĞ»Ğ»Ğ°Ñ…Ğ° ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ Ğ»ÑĞ±Ñ‹Ñ… Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¾ÑÑ‚ĞµĞ¹.",
    "ĞšĞ¾Ñ€Ğ°Ğ½ ÑƒĞºÑ€ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ¸Ğ¼Ğ°Ğ½ Ğ¸ Ğ¿Ñ€Ğ¸Ğ½Ğ¾ÑĞ¸Ñ‚ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ¸Ğµ.",
    "ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ°ÑÑ‚ â€” Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ’ÑĞµĞ²Ñ‹ÑˆĞ½ĞµĞ³Ğ¾ Ğº Ñ‚ĞµĞ±Ğµ.",
    "ĞĞ»Ğ»Ğ°Ñ… Ğ»ÑĞ±Ğ¸Ñ‚ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ ÑĞµÑ€Ğ´Ñ†Ğµ ĞšĞ¾Ñ€Ğ°Ğ½Ğ¾Ğ¼.",
    "ĞĞµ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞ¹ Ğ´Ğ½Ñ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ Ğ±ĞµĞ· Ğ°ÑÑ‚Ğ¾Ğ² ĞšĞ¾Ñ€Ğ°Ğ½Ğ°.",
    "ĞšĞ¾Ñ€Ğ°Ğ½ â€” Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº ÑĞ¸Ğ»Ñ‹ Ğ¸ Ñ‚ĞµÑ€Ğ¿ĞµĞ½Ğ¸Ñ.",
    "Ğ’ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ´Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ğ´Ğ»Ñ ĞšĞ¾Ñ€Ğ°Ğ½Ğ° â€” Ğ¸ ÑƒĞ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ğ±Ğ°Ñ€Ñ€Ğ°ĞºĞ°Ñ‚.",
]

def local_now() -> datetime:
    """Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ Ñ‚Ğ²Ğ¾ĞµĞ¼Ñƒ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ (UTC+OFFSET)."""
    return datetime.utcnow() + timedelta(hours=TIMEZONE_OFFSET)

def next_time(hour: int, minute: int = 0) -> datetime:
    """Ğ‘Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ H:M Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ°."""
    now = local_now()
    target = datetime.combine(now.date(), time(hour, minute))
    if now >= target:
        target += timedelta(days=1)
    return target

def rotation_index_for_day(d: datetime) -> int:
    """Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°ÑˆĞºĞ¸: ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾ Ğ´Ğ½Ñ, Ğ¸Ğ´Ñ‘Ğ¼ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ñ†Ğ¸ĞºĞ»."""
    return (d.date().toordinal()) % len(MOTIVATIONS)

async def daily_motivation_loop():
    """ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 22:00 Ğ¿Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°ÑˆĞºÑƒ â„–i."""
    while True:
        target = next_time(22, 0)  # 22:00 Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
        sleep_sec = (target - local_now()).total_seconds()
        await asyncio.sleep(max(0, sleep_sec))

        idx = rotation_index_for_day(target)
        text = MOTIVATIONS[idx]
        try:
            await bot.send_message(GROUP_ID, text)
        except Exception as e:
            logging.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°ÑˆĞºÑƒ: {e}")

# â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    # ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°ÑˆĞµĞº
    asyncio.create_task(daily_motivation_loop())
    # Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ¿Ğ¾Ğ»Ğ»Ğ¸Ğ½Ğ³Ğ°
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
